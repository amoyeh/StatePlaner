var __extends=this.__extends||function(d,b){function __(){this.constructor=d}for(var p in b)b.hasOwnProperty(p)&&(d[p]=b[p]);__.prototype=b.prototype,d.prototype=new __},sp;!function(sp){var StateEvent=function(){function StateEvent(target,type,values){void 0===values&&(values=null),this.target=target,this.type=type,this.values=values}return StateEvent}();sp.StateEvent=StateEvent;var EventDispatcher=function(){function EventDispatcher(){this.callBacks=[]}return EventDispatcher.prototype.addEvent=function(type,func){null==this.callBacks[type]&&(this.callBacks[type]=[]),this.callBacks[type].push({func:func})},EventDispatcher.prototype.removeEvent=function(type,func){if(null!=this.callBacks[type])for(var callbackLen=this.callBacks[type].length,k=0;callbackLen>k;k++)if(this.callBacks[type][k].func===func){this.callBacks[type].splice(k,1);break}},EventDispatcher.prototype.hasEvent=function(type,func){if(null!=this.callBacks[type])for(var callbackLen=this.callBacks[type].length,k=0;callbackLen>k;k++)if(this.callBacks[type][k].func===func)return!0;return!1},EventDispatcher.prototype.fireEvent=function(event){if(null!=this.callBacks[event.type])for(var callbackLen=this.callBacks[event.type].length,k=0;callbackLen>k;k++)this.callBacks[event.type][k].func(event)},EventDispatcher}();sp.EventDispatcher=EventDispatcher}(sp||(sp={}));var sp;!function(sp){var State=function(_super){function State(name,isInitial,isFinal){void 0===isInitial&&(isInitial=!1),void 0===isFinal&&(isFinal=!1),_super.call(this),this.isActive=!1,this.name=name,this.transitions=[],this.childs=[],this.isInitial=isInitial,this.isFinal=isFinal}return __extends(State,_super),State.prototype.addChild=function(child,mask){if(void 0===mask&&(mask=0),this.isInitial||this.isFinal)return void this.fsm.fireError("state name:"+this.name+" can not add child. (type is initial or final)");if(child.constructor===Array)for(var list=child,k=0;k<list.length;k++)this.addAChild(list[k],mask);return child.constructor===State&&this.addAChild(child,mask),this},State.prototype.addTo=function(parent,mask){return void 0===mask&&(mask=0),parent.isInitial||parent.isFinal?void this.fsm.fireError("parent state name:"+parent.name+" can not add child. (type is initial or final)"):(parent.addAChild(this,mask),this)},State.prototype.addAChild=function(child,mask){if(void 0===mask&&(mask=0),this.hasChild(child))return void this.fsm.fireError("addAChild error, state name must be unique on name: "+child.name);if(child.parent){if(child.parent===this)return void this.fsm.fireError("addAChild error, state "+child.name+" is already a child of the parent  "+this.name);child.parent.removeChild(child)}this.childs.push(child),child.parent=this,this.addTransition(child,mask)},State.prototype.addTransition=function(otherArg,mask){void 0===mask&&(mask=sp.FSM.A_TO_B);var otherAll=[];otherArg.constructor===Array&&(otherAll=otherArg),otherArg.constructor===State&&otherAll.push(otherArg);for(var q=0;q<otherAll.length;q++){var other=otherAll[q];0!=(mask&sp.FSM.BOTH)?(this.addUniqueTrans([other.name]),other.addUniqueTrans([this.name])):(0!=(mask&sp.FSM.A_TO_B)&&this.addUniqueTrans([other.name]),0!=(mask&sp.FSM.B_TO_A)&&other.addUniqueTrans([this.name]))}return this},State.prototype.addUniqueTrans=function(list){for(var k=0;k<list.length;k++){var loopName=list[k];-1==this.transitions.indexOf(loopName)&&this.name!=loopName&&this.transitions.push(loopName)}},State.prototype.removeChild=function(child){for(var clen=this.childs.length,k=0;clen>k;k++)if(this.childs[k]===child)return this.childs.splice(k,1),this;return this},State.prototype.removeAllChilds=function(){for(var clen=this.childs.length,k=0;clen>k;k++)this.childs[k].parent=null;return this.childs=[],this},State.prototype.deleteTransition=function(other,mask){void 0===mask&&(mask=sp.FSM.A_TO_B);var index=this.transitions.indexOf(other.name);if((0!=(mask&sp.FSM.A_TO_B)||0!=(mask&sp.FSM.BOTH))&&this.transitions.splice(index,1),0!=(mask&sp.FSM.B_TO_A)||0!=(mask&sp.FSM.BOTH)){var otherIndex=other.transitions.indexOf(this.name);otherIndex>-1&&other.transitions.splice(otherIndex,1)}return this},State.prototype.enter=function(){},State.prototype.exit=function(){},State.prototype.update=function(){},State.prototype.stateFinal=function(){},State.prototype.hasChild=function(child){for(var clen=this.childs.length,k=0;clen>k;k++)if(this.childs[k]===child)return!0;return!1},State}(sp.EventDispatcher);sp.State=State}(sp||(sp={}));var sp;!function(sp){var FSM=function(_super){function FSM(name){_super.call(this,name),this.history=[],this.allParents=[],this.allStates={},this.allStates[this.name]=this}return __extends(FSM,_super),FSM.prototype.createState=function(name,typeMask){if(this.allStates[name])return this.fireError('createState("'+name+'") , state already exit.'),null;var newState=new sp.State(name);return 0!=(typeMask&FSM.isInitial)&&(newState.isInitial=!0),0!=(typeMask&FSM.isFinal)&&(newState.isFinal=!0),0!=(typeMask&FSM.acceptAll)&&(newState.acceptAll=!0),this.allStates[name]=newState,newState.fsm=this,newState},FSM.prototype.getState=function(name){return this.allStates[name]},FSM.prototype.init=function(initState){this.isActive=!0,this.allStates[initState]?(this.transitions.push(initState),this.toState(initState)):this.fireError("init() state name '"+initState+"' does not exist")},FSM.prototype.buildTree=function(){function recursiveChild(rootState,loopOn){for(var clen=loopOn.childs.length,k=0;clen>k;k++)rootState.allChilds.push(loopOn.childs[k].name),recursiveChild(rootState,loopOn.childs[k])}this.history=[];for(var key in this.allStates){var loop=this.allStates[key];if(loop.allParents=[],loop.parent)for(var loopParent=loop.parent;void 0!=loopParent;)loop.allParents.push(loopParent.name),loopParent=loopParent.parent;loop.allChilds=[],loop.childs.length>0&&recursiveChild(loop,loop)}for(var key in this.allStates){var loop=this.allStates[key];if(loop.isInitial&&loop.parent&&loop.parent.addTransition(loop),loop.isFinal&&loop.parent){for(var childList=[],clen=loop.parent.childs.length,p=0;clen>p;p++){var pchild=loop.parent.childs[p];pchild.name!=loop.name&&childList.push(pchild.name)}for(var lptrans=loop.parent.transitions,lptranLen=lptrans.length,k=0;lptranLen>k;k++)if(-1==childList.indexOf(lptrans[k])&&lptrans[k]!=loop.name){var addState=this.allStates[lptrans[k]];loop.addTransition(addState)}}if(loop.acceptAll)for(var subKey in this.allStates)this.allStates[subKey]!==loop&&this.allStates[subKey].addTransition(loop)}},FSM.prototype.getCurrentState=function(){var current=this;return this.history.length>0&&(current=this.allStates[this.history[this.history.length-1]]),current},FSM.prototype.getPreviousState=function(backwardCount){var result=null;return this.history.length>=backwardCount&&(result=this.allStates[this.history[this.history.length-backwardCount-1]]),result},FSM.prototype.stateEnter=function(state,data,previous){if(!state.isActive){state.isActive=!0,this.history.push(state.name),state.enter(state,this,this.getState(previous),data),this.fireEvent(new sp.StateEvent(state,"stateEnter",{current:state,from:this.getState(previous),data:data}));for(var clen=state.childs.length,k=0;clen>k;k++)state.childs[k].isInitial&&(state.childs[k].isActive=!0,state.childs[k].enter(state.childs[k],this,this.getState(previous),data),this.history.push(state.childs[k].name),this.fireEvent(new sp.StateEvent(state.childs[k],"stateEnter",{current:state.childs[k],from:this.getState(previous),data:data})));for(;this.history.length>100;)this.history.shift()}},FSM.prototype.stateExit=function(state,data,next){state.isActive&&(state.isActive=!1,state.exit(state,this,this.getState(next),data),this.fireEvent(new sp.StateEvent(state,"stateExit",{current:state,next:this.getState(next),data:data})))},FSM.prototype.stateFinal=function(stateArg,data){var state;return"string"==typeof stateArg&&(state=this.allStates[stateArg],void 0==state)?void this.fireError("finalStateExit() state : "+state.name+" not found."):(stateArg.constructor===sp.State&&(state=stateArg),0==state.isFinal?void this.fireError("state : "+state.name+" is not a finalState"):(this.stateExit(state),void(state.parent&&state.parent.name!=this.name&&(state.parent.stateFinal(state.parent,this,state,data),this.fireEvent(new sp.StateEvent(state.parent,"stateFinal",{current:state.parent,from:state,data:data}))))))},FSM.prototype.toState=function(toState,data){var current=this.getCurrentState(),nextState=this.allStates[toState];if(-1==current.transitions.indexOf(toState))return this.fireError(current.name+" doesn't have transition to: "+toState+" , "+current.name+" transitions are: "+current.transitions),!1;nextState.parent.name!=current.name&&this.stateExit(current,data,nextState.name);for(var cps=current.allParents.concat(),nps=nextState.allParents.concat(),exitParentNames=[],c=0;c<cps.length;c++)-1==nps.indexOf(cps[c])&&exitParentNames.push(cps[c]);for(var q=0;q<exitParentNames.length;q++){var ep=this.allStates[exitParentNames[q]];this.stateExit(ep,data,nextState.name)}for(var parentReverse=nextState.allParents.concat().reverse(),p=0;p<parentReverse.length;p++){var loopP=this.allStates[parentReverse[p]];loopP&&(loopP.isActive||this.stateEnter(loopP,data,current.name))}return this.stateEnter(nextState,data,current.name),this.fsmui&&this.fsmui.toCurrentState(),!0},FSM.prototype.fireError=function(msg){this.fireEvent(new sp.StateEvent(this,"error",{msg:msg}))},FSM.A_TO_B=1,FSM.B_TO_A=2,FSM.BOTH=4,FSM.isInitial=1,FSM.isFinal=2,FSM.acceptAll=4,FSM}(sp.State);sp.FSM=FSM}(sp||(sp={}));